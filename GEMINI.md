# GEMINI.md：一人インフラ課・防衛憲法（MVP反復・完遂型 / 最終確定版）

## 1. 開発哲学：インフラ一人体制の最終兵器

AIを「魔法」ではなく「厳格な書記」および「手順の執行官」として運用する。AIは独断で動かず、常に「設計」と「事実（Gitの差分）」を人間に提示し、言質を取ってから実行せよ。

### ① 憲法（本ドキュメント）：大原則と行動規範

* プロジェクト全体で共通の「掟」。AIの動作OS。一度決めたら原則変更しない。

### ② 親指示書（Master Plan）：`workplans/ISSUE_[ID]_MASTER.md`

* **役割**: イシュー全体の戦略図。概要設計、テスト設計、最終ゴール、および全サイクルの履歴を管理する。
* **作成タイミング**: 人間がイシュー開始（Phase 1）を命じた直後にAIが起案。

### ③ 子指示書（MVP Cycle）：`workplans/ISSUE_[ID]_MVP_[SEQ].md`

* **役割**: 1つのMVP（検証可能な最小単位）ごとの戦術図。詳細設計、今回の検証内容、進捗記録（State Ledger）。
* **作成タイミング**: 各MVPサイクルの開始直後（Step 2）にAIが起案。

---

## 2. 掟：Git 操作と「点呼」の義務（物理制約）

フェーズやサイクルに関わらず、すべての Git 操作において以下の手順を徹底せよ。

* **自己調査の徹底**: 起動・再開直後、自ら `git branch`, `git status`, `git diff main...HEAD`, `git log main..HEAD` を実行せよ。
* **三点照合の点呼**: 調査結果を指示書のTodo状況と照らし合わせ「[ブランチ名] で作業中、[ファイル名] に修正あり、現在のMVP状況は [項目] です。合っていますか？」と人間に問い、合意を得るまで作業を禁止する。
* **statusの義務**: **`git add` を行う直前には、必ず `git status` を実行せよ。** 人間の手動修正を検知・同期してからステージングせよ。
* **管理の掟**: **いかなるファイル更新も作業ブランチ（PR）を経由せよ。** 1つのMVPサイクル = 1つの作業ブランチとする。

---

## 3. 全行程ワークフロー：イシューの開始から終了まで

### Phase 1：イシュー開始（人間によるトリガー）

1. **開始宣言**: 人間がイシューID（例：#123）を提示し「開始せよ」と命じる。
2. **親指示書の起案**: AIは `gh issue view [ID]` を読み込み、`workplans/ISSUE_[ID]_MASTER.md` を作成せよ。作成直後に **`markdownlint`** を実行せよ。

### Phase 2：MVPループ（反復サイクル）

イシュー解決まで以下を繰り返せ。マージ後に動かなかった場合も、新しいサイクルとして再開せよ。

* **Step 1: サイクル定義**: 親指示書に基づき、今回の「最小のゴール」と「検収基準」を定義せよ。
* **Step 2: 子指示書の作成**: `workplans/ISSUE_[ID]_MVP_[SEQ].md` を新規作成せよ。作成直後に **`markdownlint`** を実行せよ。
* **Step 3: ブランチ作成**: **ここで `feat/issue-[ID]-mvp-[SEQ]` ブランチを作成せよ。**
* **Step 4: 検証資産の準備**: 親指示書の「テスト設計」に基づき、検証スクリプト（`scripts/verify.sh`等）を先に作成・更新せよ。
* **Step 5: 実装とバリデーション**: 詳細設計に基づきHCLを修正。
  * 実行必須: **`markdownlint`**, `terraform fmt`, `validate`, `tflint`, `terraform plan` を完遂せよ。
* **Step 6: PR作成とマージ**: `git status` 確認後、PR作成・マージせよ。
  * **重要（リカバリ）**: CI Apply が失敗した場合は Step 7 へ進まず即座に停止せよ。人間とリカバリ用サイクルを再設計せよ。
* **Step 7: 動作証明**: 資産化したテストを実行。結果を `gh gist create` で保存し、子指示書にリンクせよ。
* **Step 8: 環境同期**: `git checkout main`, `git pull` を行い、作業ブランチを削除せよ。手元をクリーンに戻せ。
* **Step 9: 知見の還流と継続判断**: 今回得た制約や知見を **親指示書へ書き戻して同期** せよ。未完了項目があれば **Step 1** へ戻れ。

### Phase 3：イシュー完遂

1. **ドキュメント最終化**: **`doc/issue-[ID]-final` 等のブランチを切り**、`README.md` に知見や Gist リンクを追記せよ。
2. **マージと反映**: PRを作成し、人間によるマージを経て `main` を更新せよ。
3. **墓場送り**: `gh issue close` を実行し、全工程の完遂を報告せよ。

---

## 4. なぜこのルールが必要か

* **自作自演（エコーチェンバー）**: AIのミスをAIのテストで通す。→ **対策：人間が検収基準をロックする。**
* **State Ledgerの更新漏れ**: 記録を怠り二重修正する。→ **対策：点呼による事実（Gitログ・差分）との三点照合。**
* **ドキュメントの腐敗**: 構造が崩れた指示書が放置される。→ **対策：`markdownlint` の強制実行。**
* **環境のねじれ**: マージ後の不具合を無視する。→ **対策：MVPループの再起動による知見の親への還流。**

---

## 5. 指示書テンプレート

AIはファイル作成時、以下の構造を完全にコピーして使用せよ。

### ① 親指示書テンプレート（workplans/ISSUE_[ID]_MASTER.md）

```markdown

# ISSUE_[ID] MASTER PLAN (Grand Design)

## 1. イシュー概要

### GitHub Issue #[ID]

### 目的/最終ゴール

### 背景/制約事項 (サイクルで得た知見をここに追記せよ)

## 2. 概要設計

### 現状の分析 

### アーキテクチャ構成案

### モジュール分割・リソース構成

## 3. テスト設計 (Master Test Design)

### 検証項目(何をテストするか)

### 検証手順*(実行コマンド、引数、順序)

### 期待値（正常/異常）(ステータス、レスポンスコード等)

### テスト資産 (原則 scripts/verify.sh 等を更新)

### 終了条件（定義）

## 4. MVPサイクル履歴

* [ ] MVP 1: [名称] - [完了ステータス]
* [ ] MVP 2: [名称] - [完了ステータス]

```

### ② 子指示書テンプレート（workplans/ISSUE_[ID]_MVP_[SEQ].md）

```markdown
# ISSUE_[ID] MVP [SEQ] (State Ledger)

## 1. サイクル概要

### 今回のゴール: 

### 検収基準（人間がここをロックする）

* [ ] 

## 2. 今回の検証内容 (Based on Master Test Design)

### 検証項目(今回のサイクルで特に確認するリソースや設定)

### 実行手順 (実際に叩くコマンドとオプション)

### 判定基準(成功とみなす具体的なキーワードやステータス)

## 3. 詳細設計

### 修正ファイル一覧

### リソース定義詳細

### 依存関係/IAM権限

## 4. Todo (State Ledger)

* [ ] Step 1: サイクル定義・検収基準確定完了
* [ ] Step 2: 子指示書作成・ブランチ作成完了
* [ ] Step 3: 検証資産更新完了
* [ ] Step 4: HCL実装・バリデーション(lint/fmt/val/plan)完了
* [ ] Step 5: PR作成・マージ・CI Apply 完了 (失敗時は停止)
* [ ] Step 6: 動作証明・Gistエビデンス取得完了
* [ ] Step 7: 環境同期・ブランチ削除完了
* [ ] Step 8: 知見の親への還流・継続判断完了

## 5. 作業手順書 (Command List)

* (AIが実行する生コマンドのリスト)

```
